name: ELT Pipeline (Daily)

on:
  schedule:
    - cron: "0 19 * * *" # ë§¤ì¼ 19:00 UTC (í•œêµ­ ì‹œê°„ 04:00)ì— ì‹¤í–‰, ì£¼ë§ì— full refresh

  workflow_dispatch:
    inputs:
      target_date:
        description: "ì‹¤í–‰í•  ë‚ ì§œ, í˜•ì‹: YYYY-MM-DD (ì§€ì •í•˜ì§€ ì•Šìœ¼ë©´ ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì‹¤í–‰)"
        required: false
        type: string
      full_refresh:
        description: "ì „ì²´ ë°ì´í„°ë¥¼ ë‹¤ì‹œ ìˆ˜ì§‘í• ì§€ ì—¬ë¶€ (ê¸°ë³¸ê°’: false)"
        required: false
        type: boolean
        default: false

jobs:
  run-elt-pipeline:
    runs-on: ubuntu-latest

    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
      S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}
      IGDB_CLIENT_ID: ${{ secrets.IGDB_CLIENT_ID }}
      IGDB_STATIC_TOKEN: ${{ secrets.IGDB_STATIC_TOKEN }}
      CLOUDFRONT_DOMAIN: ${{ secrets.CLOUDFRONT_DOMAIN }}
      CLOUDFRONT_DISTRIBUTION_ID: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}
      DBT_PROFILES_DIR: ./transform

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: true

      - name: Install dependencies
        run: |
          uv venv
          uv sync --extra dev

      - name: Determine Target Date
        id: date
        run: |
          if [ "${{ inputs.target_date }}" != "" ]; then
            echo "DATE=${{ inputs.target_date }}" >> $GITHUB_OUTPUT
            echo "TARGET_DATE=${{ inputs.target_date }}" >> $GITHUB_STEP_SUMMARY

          else
            TODAY=$(date +'%Y-%m-%d')
            echo "DATE=$TODAY" >> $GITHUB_OUTPUT
            echo "TARGET_DATE=$TODAY" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Determine Full Refresh Mode
        id: full_refresh
        run: |
          IS_FULL_REFRESH="false"
          REASON="Daily scheduled run"

          if [ "${{ inputs.full_refresh }}" == "true" ]; then
            IS_FULL_REFRESH="true"
            REASON="Manual trigger"
          fi

          DAY_OF_WEEK=$(date +%u)
          if [ "${{ github.event_name }}" == "schedule" ] && [ "$DAY_OF_WEEK" == "7" ]; then
            IS_FULL_REFRESH="true"
            REASON="Scheduled full refresh on Sunday"
          fi

          echo "FULL_REFRESH=$IS_FULL_REFRESH" >> $GITHUB_OUTPUT

          echo "### Pipeline Execution Mode" >> $GITHUB_STEP_SUMMARY
          echo "- **Mode**: Full Refresh: $IS_FULL_REFRESH" >> $GITHUB_STEP_SUMMARY
          echo "- **Reason**: $REASON" >> $GITHUB_STEP_SUMMARY
          echo "- **Target Date**: ${{ steps.date.outputs.DATE }}" >> $GITHUB_STEP_SUMMARY

      - name: Run Extract and Load
        id: el_step
        timeout-minutes: 30
        run: |
          set -e
          FLAGS="--date ${{ steps.date.outputs.DATE }}"

          if [ "${{ steps.full_refresh.outputs.FULL_REFRESH }}" = "true" ]; then
            FLAGS="$FLAGS --full-refresh"
            echo "FULL REFRESH: Enabled" >> $GITHUB_STEP_SUMMARY
          else
            echo "FULL REFRESH: Disabled" >> $GITHUB_STEP_SUMMARY
          fi

          echo "Running pipeline with flags: $FLAGS"

          uv run scripts/run_pipeline.py $FLAGS

      - name: Run dbt Transformations
        if: success()
        timeout-minutes: 30
        env:
          DBT_PROFILES_DIR: .
        run: |
          DBT_FLAGS=""
          if [ "${{ steps.full_refresh.outputs.FULL_REFRESH }}" = "true" ]; then
            DBT_FLAGS="--full-refresh"
          fi

          cd transform
          uv run dbt deps

          echo "Running dbt for partition: ${{ steps.date.outputs.DATE }}"

          uv run dbt run --target prod_s3 \
            --vars '{"partition_date": "${{ steps.date.outputs.DATE }}"}' \
            $DBT_FLAGS

          uv run dbt test --target prod_s3 \
            --vars '{"partition_date": "${{ steps.date.outputs.DATE }}"}' \

      - name: Restart Streamlit Dashboard
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          port: 22
          script: |
            echo "ğŸ”„ Data Updated! Restarting Dashboard..."
            # ì„œë¹„ìŠ¤ ì¬ì‹œì‘ (ìºì‹œ ì´ˆê¸°í™” & DB ì¬ì—°ê²° íš¨ê³¼)
            sudo systemctl restart dashboard
            echo "âœ… Dashboard Restarted Successfully!"
